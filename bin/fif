#!/bin/bash
#
# fif: Find in files
# Usage: fif [OPTIONS] PATTERN

[ -z "$1" ] && echo "Usage: $0 PATTERN" && exit 1

# TODO exclude option
# TODO format option

IFS=$'\n'

res=($(grep -Rns --exclude-dir="package" $1))
files=($(printf '%s\n' ${res[@]} | cut -f1 -d':' | uniq))

for i in "${!files[@]}"; do
    printf '\n\e[35m%s\e[m\n' "${files[$i]}"
    section=($(printf '%s\n' ${res[@]} | grep -w "${files[$i]}"))
    lines=($(printf '%s\n' ${section[@]} | cut -f2 -d':'))
    matches=($(printf '%s\n' ${section[@]} | cut -f3 -d':'))
    for j in "${!section[@]}"; do
        printf '\e[32m%s\e[0m\e[1;34m: \e[0m%s\n' "${lines[$j]}" "$(echo ${matches[$j]} | sed 's/^[ \t]*//' | sed "/$1/s//`printf "\033[1;31m$1\033[0m/"`")"
    done
done

unset IFS

